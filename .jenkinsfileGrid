pipeline {
    agent any

    stages {
        stage('Start Grid') {
            steps {
                sh 'docker-compose up -d'
            }
        }
        stage('Export Xray Tests') {
                steps {
                    sh 'java -cp target/test-classes XrayIntegration.XrayExecutionManager'
                }
        }

        stage('Initial Test Run') {
                steps {
                    sh 'mvn clean test -DskipRerun=true'
                }
                post {
                    always {
                        archiveArtifacts artifacts: 'target/cucumber.json'
                    }
                }
        }
        stage('Rerun Failed Tests') {
                when {
                    expression { fileExists('target/rerun.txt') }
                }
                steps {
                    sh 'mvn test -Dtest=RerunXrayTestRunner'
                }
                post {
                    always {
                        archiveArtifacts artifacts: 'target/cucumber-rerun.json'
                    }
                }
        }
        stage('Merge Results') {
                steps {
                    sh 'java -cp target/test-classes utils.CucumberResultMerger'
                }
        }
        stage('Upload Results to Xray') {
                steps {
                    sh 'java -cp target/test-classes XrayIntegration.XrayResultUploader'
                }
        }
        stage('Reports') {
            steps {
                publishHTML(target: [
                    reportDir: 'target',
                    reportFiles: 'cucumber-report.html',
                    reportName: 'Cucumber Report'
                ])
            }
        }
    }
}
